<!doctype html>
<title>Instant Video Upload</title>
<h1>Select a Video to Upload Instantly</h1>

<form id="uploadForm" method="post" enctype="multipart/form-data">
  <input type="file" name="file" id="videoFile" accept="video/*">
</form>

<div id="statusMessage" style="margin-top: 20px;"></div>
<div id="videoContainer" style="margin-top: 20px;"></div>

<script>
  // Get references to the elements
  const fileInput = document.getElementById('videoFile');
  const statusMessage = document.getElementById('statusMessage');
  const videoContainer = document.getElementById('videoContainer');
  const uploadForm = document.getElementById('uploadForm');

  // Listen for the file selection event
  fileInput.addEventListener('change', function() {
    // Check if a file was selected
    if (this.files.length === 0) {
      return;
    }

    const file = this.files[0];
    statusMessage.innerHTML = `Uploading **${file.name}**...`;
    videoContainer.innerHTML = ''; // Clear previous video

    // Use FormData to build the multipart/form-data payload
    const formData = new FormData(uploadForm);
    // You could also manually append the file: formData.append('file', file);

    // Use the Fetch API to send the file asynchronously
    fetch('{{ url_for("upload_ajax") }}', {
      method: 'POST',
      body: formData // The body is the FormData object
    })
    .then(response => {
      // Check for HTTP errors (4xx or 5xx)
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json(); // Parse the JSON response
    })
    .then(data => {
      if (data.success) {
        statusMessage.innerHTML = `<span style="color: green;">${data.message}</span>`;
        displayVideo(data.url, data.filename);
      } else {
        statusMessage.innerHTML = `<span style="color: red;">Upload Failed: ${data.message}</span>`;
      }
    })
    .catch(error => {
      statusMessage.innerHTML = `<span style="color: red;">An error occurred during upload: ${error.message}</span>`;
      console.error('Fetch error:', error);
    });
  });

  // Helper function to display the video
  function displayVideo(url, filename) {
    const videoHTML = `
      <h2>${filename}</h2>
      <video width="400" controls>
        <source src="${url}" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    `;
    videoContainer.innerHTML = videoHTML;
  }
</script>